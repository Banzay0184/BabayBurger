# Руководство по тестированию системы доставки StreetBurger

## Обзор

Данное руководство описывает комплексную систему тестирования для проверки всех компонентов системы доставки фастфуда, включая бэкенд операторов, API интеграцию и нагрузочное тестирование.

## Структура тестов

### 1. Комплексный системный тест (`comprehensive_system_test.py`)

Проверяет все компоненты системы:

- **Подключение к базе данных**
- **Создание всех моделей**
- **Workflow оператора** (полный цикл обработки заказа)
- **Производительность запросов**
- **Нагрузочное тестирование** (50, 200, 500 заказов)
- **Производительность кэша**
- **Использование памяти**

### 2. API интеграционные тесты (`api_integration_test.py`)

Проверяет все API эндпоинты:

- **Регистрация оператора**
- **Аутентификация**
- **Управление профилем**
- **Сессии оператора**
- **Управление заказами**
- **Уведомления**
- **Аналитика**
- **Зоны доставки**

### 3. Стандартные Django тесты

Запускаются через `python manage.py test`

## Запуск тестов

### Быстрый запуск всех тестов

```bash
cd backend
python run_comprehensive_tests.py
```

### Поэтапный запуск

1. **Применение миграций:**
```bash
python manage.py migrate
```

2. **Создание тестовых данных:**
```bash
python manage.py create_test_operators --clear
```

3. **Комплексный системный тест:**
```bash
python comprehensive_system_test.py
```

4. **API интеграционные тесты:**
```bash
python api_integration_test.py
```

5. **Стандартные Django тесты:**
```bash
python manage.py test app_operator api --verbosity=2
```

## Нагрузочное тестирование

### Уровни нагрузки

1. **Легкая нагрузка** (50 заказов, 5 потоков)
   - Проверка базовой функциональности
   - Время выполнения: ~30 секунд

2. **Средняя нагрузка** (200 заказов, 10 потоков)
   - Проверка производительности
   - Время выполнения: ~60 секунд

3. **Высокая нагрузка** (500 заказов, 20 потоков)
   - Стресс-тестирование
   - Время выполнения: ~120 секунд

### Метрики производительности

- **Заказов в секунду** (создание)
- **Заказов в секунду** (обработка)
- **Время отклика API**
- **Использование памяти**
- **Производительность кэша**

## Интерпретация результатов

### Успешные тесты

```
✅ Подключение к базе данных - ПРОЙДЕН
✅ Создание всех моделей - ПРОЙДЕН
✅ Workflow оператора - ПРОЙДЕН
✅ Производительность запросов - ПРОЙДЕН
✅ Нагрузочный тест (500 заказов) - ПРОЙДЕН
```

### Проваленные тесты

```
❌ Подключение к базе данных - ПРОВАЛЕН: connection refused
❌ Создание всех моделей - ПРОВАЛЕН: field validation error
```

### Рекомендации по оптимизации

#### Если низкая производительность создания заказов (< 10/сек):
- Проверить индексы базы данных
- Оптимизировать запросы
- Рассмотреть кэширование

#### Если много ошибок при нагрузочном тестировании:
- Проверить настройки базы данных
- Увеличить лимиты соединений
- Оптимизировать код

#### Если высокое использование памяти:
- Проверить утечки памяти
- Оптимизировать запросы
- Рассмотреть пагинацию

## Мониторинг во время тестирования

### База данных

```sql
-- Проверка активных соединений
SELECT COUNT(*) FROM pg_stat_activity;

-- Проверка производительности запросов
SELECT query, mean_time, calls 
FROM pg_stat_statements 
ORDER BY mean_time DESC;
```

### Системные ресурсы

```bash
# Мониторинг CPU и памяти
htop

# Мониторинг дискового I/O
iotop

# Мониторинг сети
iftop
```

## Автоматизация тестирования

### CI/CD интеграция

Добавьте в ваш CI/CD pipeline:

```yaml
test:
  script:
    - cd backend
    - python run_comprehensive_tests.py
  artifacts:
    reports:
      junit: test-results.xml
```

### Планировщик задач

Для регулярного тестирования добавьте в crontab:

```bash
# Ежедневное тестирование в 2:00
0 2 * * * cd /path/to/backend && python run_comprehensive_tests.py >> test.log 2>&1
```

## Устранение неполадок

### Частые проблемы

1. **Ошибка подключения к базе данных**
   - Проверить настройки DATABASE в settings.py
   - Убедиться, что база данных запущена

2. **Ошибки миграций**
   - Удалить db.sqlite3 и пересоздать миграции
   - Проверить совместимость миграций

3. **Ошибки аутентификации**
   - Проверить настройки JWT
   - Убедиться, что операторы созданы

4. **Низкая производительность**
   - Проверить индексы базы данных
   - Оптимизировать запросы
   - Рассмотреть кэширование

### Логи тестирования

Все результаты тестирования сохраняются в:

- `test.log` - общий лог тестов
- `performance_results.json` - результаты производительности
- `load_test_results.json` - результаты нагрузочного тестирования

## Расширение тестов

### Добавление новых тестов

1. Создайте новый тест в `comprehensive_system_test.py`:

```python
def test_new_feature(self):
    """Тест новой функциональности"""
    try:
        # Ваш тест
        self.log_test("Новая функциональность")
        return True
    except Exception as e:
        self.log_test("Новая функциональность", False, e)
        return False
```

2. Добавьте вызов в `run_all_tests()`:

```python
self.test_new_feature()
```

### Кастомные нагрузочные тесты

Создайте новый метод для специфичных тестов:

```python
def custom_load_test(self, scenario):
    """Кастомный нагрузочный тест"""
    # Ваша логика тестирования
    pass
```

## Заключение

Комплексная система тестирования обеспечивает:

- ✅ **Полное покрытие** всех компонентов системы
- ✅ **Нагрузочное тестирование** для проверки производительности
- ✅ **API интеграционные тесты** для проверки интерфейсов
- ✅ **Автоматизацию** тестирования
- ✅ **Детальную отчетность** с рекомендациями

Регулярное выполнение этих тестов гарантирует стабильность и производительность системы доставки. 